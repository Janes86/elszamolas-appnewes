<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Apartmanok elszÃ¡molÃ¡sai</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@300;400;500&family=DM+Sans:wght@300;400;500;600&display=swap');

  :root {
    --bg: #0f0f0f;
    --surface: #1a1a1a;
    --surface2: #242424;
    --border: #2e2e2e;
    --accent: #c8a96e;
    --accent2: #7eb8a4;
    --text: #e8e4dc;
    --text2: #8a8580;
    --danger: #c97070;
    --success: #7eb8a4;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    min-height: 100vh;
  }

  header {
    border-bottom: 1px solid var(--border);
    padding: 24px 40px;
    display: flex;
    align-items: baseline;
    gap: 16px;
    background: var(--bg);
    position: sticky;
    top: 0;
    z-index: 100;
  }

  header h1 {
    font-family: 'DM Serif Display', serif;
    font-size: 22px;
    color: var(--accent);
    letter-spacing: 0.02em;
  }

  header span {
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    color: var(--text2);
    letter-spacing: 0.1em;
    text-transform: uppercase;
  }

  .layout {
    display: grid;
    grid-template-columns: 280px 1fr;
    min-height: calc(100vh - 73px);
  }

  /* SIDEBAR */
  .sidebar {
    border-right: 1px solid var(--border);
    padding: 24px 0;
    background: var(--surface);
  }

  .sidebar-section {
    padding: 0 20px;
    margin-bottom: 8px;
  }

  .sidebar-label {
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--text2);
    padding: 16px 20px 8px;
    display: block;
  }

  .apt-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 20px;
    cursor: pointer;
    border-radius: 0;
    transition: background 0.15s;
    border-left: 2px solid transparent;
  }

  .apt-item:hover { background: var(--surface2); }

  .apt-item.active {
    background: var(--surface2);
    border-left-color: var(--accent);
  }

  .apt-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--text2);
    flex-shrink: 0;
  }

  .apt-item.active .apt-dot { background: var(--accent); }
  .apt-item.has-file .apt-dot { background: var(--success); }

  .apt-name {
    font-size: 13px;
    color: var(--text);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .apt-sub {
    font-size: 11px;
    color: var(--text2);
    font-family: 'DM Mono', monospace;
  }

  .add-apt-btn {
    margin: 8px 20px;
    width: calc(100% - 40px);
    padding: 9px;
    background: transparent;
    border: 1px dashed var(--border);
    color: var(--text2);
    font-family: 'DM Sans', sans-serif;
    font-size: 12px;
    cursor: pointer;
    border-radius: 4px;
    transition: all 0.15s;
  }

  .add-apt-btn:hover {
    border-color: var(--accent);
    color: var(--accent);
  }

  /* MAIN */
  .main {
    padding: 40px;
    max-width: 900px;
  }

  .page-title {
    font-family: 'DM Serif Display', serif;
    font-size: 28px;
    color: var(--text);
    margin-bottom: 6px;
  }

  .page-sub {
    font-size: 13px;
    color: var(--text2);
    margin-bottom: 32px;
  }

  /* STEPS */
  .steps {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .step {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
  }

  .step-header {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 16px 20px;
    cursor: pointer;
    transition: background 0.15s;
  }

  .step-header:hover { background: var(--surface2); }

  .step-num {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    border: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'DM Mono', monospace;
    font-size: 12px;
    color: var(--text2);
    flex-shrink: 0;
  }

  .step.done .step-num {
    background: var(--success);
    border-color: var(--success);
    color: var(--bg);
  }

  .step-title { font-size: 15px; font-weight: 500; }
  .step-desc { font-size: 12px; color: var(--text2); margin-top: 2px; }

  .step-body {
    padding: 0 20px 20px 62px;
    display: none;
  }

  .step.open .step-body { display: block; }

  /* UPLOAD ZONE */
  .upload-zone {
    border: 1px dashed var(--border);
    border-radius: 6px;
    padding: 28px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
  }

  .upload-zone:hover, .upload-zone.dragover {
    border-color: var(--accent);
    background: rgba(200, 169, 110, 0.04);
  }

  .upload-zone input[type=file] {
    position: absolute;
    inset: 0;
    opacity: 0;
    cursor: pointer;
  }

  .upload-icon { font-size: 28px; margin-bottom: 8px; }
  .upload-text { font-size: 13px; color: var(--text2); }
  .upload-text strong { color: var(--accent); }

  .file-badge {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: rgba(126, 184, 164, 0.1);
    border: 1px solid var(--success);
    border-radius: 4px;
    padding: 8px 14px;
    font-size: 12px;
    color: var(--success);
    font-family: 'DM Mono', monospace;
    margin-top: 12px;
  }

  /* TEXTAREA */
  .payout-textarea {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 12px;
    padding: 14px;
    resize: vertical;
    min-height: 160px;
    outline: none;
    transition: border-color 0.15s;
    line-height: 1.6;
  }

  .payout-textarea:focus { border-color: var(--accent); }
  .payout-textarea::placeholder { color: var(--text2); }

  /* PARSED PREVIEW */
  .parsed-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
    margin-top: 12px;
    font-family: 'DM Mono', monospace;
  }

  .parsed-table th {
    text-align: left;
    color: var(--text2);
    font-weight: 400;
    padding: 6px 10px;
    border-bottom: 1px solid var(--border);
    font-size: 11px;
    letter-spacing: 0.05em;
  }

  .parsed-table td {
    padding: 8px 10px;
    border-bottom: 1px solid var(--border);
    color: var(--text);
  }

  .parsed-table tr:last-child td { border-bottom: none; }

  .parsed-table td.num { color: var(--accent); }
  .parsed-table td.eur { color: var(--accent2); }

  /* MONTH SELECT */
  .month-row {
    display: flex;
    gap: 10px;
    margin-bottom: 16px;
    flex-wrap: wrap;
  }

  .month-btn {
    padding: 7px 14px;
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text2);
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    cursor: pointer;
    border-radius: 4px;
    transition: all 0.15s;
    letter-spacing: 0.05em;
  }

  .month-btn:hover { border-color: var(--accent); color: var(--accent); }
  .month-btn.active { background: var(--accent); border-color: var(--accent); color: var(--bg); font-weight: 500; }

  /* EXTRA COSTS */
  .extra-row {
    display: flex;
    gap: 8px;
    margin-bottom: 8px;
    align-items: center;
  }

  .input-field {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 4px;
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    padding: 8px 12px;
    outline: none;
    transition: border-color 0.15s;
  }

  .input-field:focus { border-color: var(--accent); }
  .input-field::placeholder { color: var(--text2); }
  .input-field.wide { flex: 1; }

  .remove-btn {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text2);
    width: 30px;
    height: 30px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.15s;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .remove-btn:hover { border-color: var(--danger); color: var(--danger); }

  .add-extra-btn {
    background: transparent;
    border: 1px dashed var(--border);
    color: var(--text2);
    font-size: 12px;
    padding: 7px 14px;
    border-radius: 4px;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    transition: all 0.15s;
    margin-top: 4px;
  }

  .add-extra-btn:hover { border-color: var(--accent2); color: var(--accent2); }

  /* GENERATE BTN */
  .generate-btn {
    width: 100%;
    padding: 14px;
    background: var(--accent);
    color: var(--bg);
    border: none;
    border-radius: 6px;
    font-family: 'DM Sans', sans-serif;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    letter-spacing: 0.02em;
    margin-top: 8px;
  }

  .generate-btn:hover { background: #d4b87e; transform: translateY(-1px); }
  .generate-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

  /* STATUS */
  .status-bar {
    padding: 10px 16px;
    border-radius: 6px;
    font-size: 13px;
    margin-top: 12px;
    display: none;
  }

  .status-bar.info { background: rgba(126, 184, 164, 0.1); border: 1px solid var(--success); color: var(--success); }
  .status-bar.error { background: rgba(201, 112, 112, 0.1); border: 1px solid var(--danger); color: var(--danger); }
  .status-bar.show { display: block; }

  /* MODAL */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    z-index: 200;
    display: none;
    align-items: center;
    justify-content: center;
  }

  .modal-overlay.show { display: flex; }

  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 28px;
    width: 360px;
    max-width: 90vw;
  }

  .modal h3 {
    font-family: 'DM Serif Display', serif;
    font-size: 20px;
    margin-bottom: 20px;
    color: var(--accent);
  }

  .modal-btns {
    display: flex;
    gap: 10px;
    margin-top: 20px;
    justify-content: flex-end;
  }

  .btn-primary {
    padding: 9px 20px;
    background: var(--accent);
    color: var(--bg);
    border: none;
    border-radius: 4px;
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.15s;
  }

  .btn-primary:hover { background: #d4b87e; }

  .btn-ghost {
    padding: 9px 20px;
    background: transparent;
    color: var(--text2);
    border: 1px solid var(--border);
    border-radius: 4px;
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.15s;
  }

  .btn-ghost:hover { border-color: var(--text2); color: var(--text); }

  /* EMPTY STATE */
  .empty-state {
    text-align: center;
    padding: 80px 40px;
    color: var(--text2);
  }

  .empty-state .icon { font-size: 48px; margin-bottom: 16px; }
  .empty-state h2 { font-family: 'DM Serif Display', serif; font-size: 22px; color: var(--text); margin-bottom: 8px; }
  .empty-state p { font-size: 14px; line-height: 1.6; max-width: 320px; margin: 0 auto; }

  label.field-label {
    display: block;
    font-size: 11px;
    color: var(--text2);
    font-family: 'DM Mono', monospace;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    margin-bottom: 6px;
    margin-top: 14px;
  }

  .parse-btn {
    margin-top: 10px;
    padding: 8px 18px;
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 12px;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.15s;
  }

  .parse-btn:hover { border-color: var(--accent2); color: var(--accent2); }

  .warning-note {
    font-size: 11px;
    color: var(--text2);
    margin-top: 6px;
    font-family: 'DM Mono', monospace;
  }

  .divider {
    height: 1px;
    background: var(--border);
    margin: 20px 0;
  }
</style>
</head>
<body>

<header>
  <h1>Apartmanok elszÃ¡molÃ¡sai</h1>
  <span>Havi Booking / Airbnb feldolgozÃ³</span>
</header>

<div class="layout">
  <!-- SIDEBAR -->
  <div class="sidebar">
    <span class="sidebar-label">LakÃ¡sok excel tÃ¡blÃ¡zatai</span>
    <div id="aptList"></div>
    <div class="sidebar-section">
      <div style="position:relative">
        <button class="add-apt-btn" onclick="document.getElementById('bulkUpload').click()">+ Excel(ek) feltÃ¶ltÃ©se</button>
        <input type="file" id="bulkUpload" accept=".xlsx,.xls" multiple style="display:none" onchange="handleBulkUpload(event)" />
      </div>
    </div>
  </div>

  <!-- MAIN -->
  <div class="main" id="mainContent">
    <div class="empty-state">
      <div class="icon">ğŸ </div>
      <h2>VÃ¡lassz tÃ¡blÃ¡zatot</h2>
      <p>Adj hozzÃ¡ lakÃ¡s excel tÃ¡blÃ¡zatokat a bal oldali panelen, majd tÃ¶ltsd fel a sablont Ã©s a Booking/Airbnb adatokat.</p>
    </div>
  </div>
</div>

<!-- ADD APARTMENT MODAL -->
<div class="modal-overlay" id="addModal">
  <div class="modal" style="width:440px">
    <h3>Adatok megadÃ¡sa</h3>
    <div id="modalFileBadge" style="margin-bottom:12px"></div>
    <label class="field-label">Tulajdonos neve</label>
    <input class="input-field" style="width:100%" id="newAptOwner" placeholder="pl. Kiss JÃ¡nos" />
    <label class="field-label">MegjegyzÃ©s (opcionÃ¡lis)</label>
    <input class="input-field" style="width:100%" id="newAptNotes" placeholder="pl. AsbÃ³th, MÃ¡ria, Somogyi" />
    <div class="modal-btns">
      <button class="btn-ghost" onclick="hideAddModal()">MÃ©gse</button>
      <button class="btn-primary" onclick="addApartment()">MentÃ©s</button>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
// â”€â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveState(key, val) {
  try { sessionStorage.setItem(key, JSON.stringify(val)); } catch(e) {}
}
function loadState(key, def) {
  try { const v = sessionStorage.getItem(key); return v ? JSON.parse(v) : def; } catch(e) { return def; }
}

let apartments = loadState('apartments', []);
let selectedApt = null;
let excelFiles = loadState('excelFiles', {});
let currentParsed = [];
let extraCosts = [];

const MONTHS_HU = ['JanuÃ¡r','FebruÃ¡r','MÃ¡rcius','Ãprilis','MÃ¡jus','JÃºnius','JÃºlius','Augusztus','Szeptember','OktÃ³ber','November','December'];
const MONTHS_EN = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

// â”€â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderSidebar() {
  const list = document.getElementById('aptList');
  if (apartments.length === 0) {
    list.innerHTML = '<div style="padding:10px 20px;font-size:12px;color:var(--text2)">MÃ©g nincs lakÃ¡s</div>';
    return;
  }
  list.innerHTML = apartments.map(apt => `
    <div class="apt-item ${selectedApt?.id === apt.id ? 'active' : ''} ${excelFiles[apt.id] ? 'has-file' : ''}" 
         onclick="selectApt('${apt.id}')">
      <div class="apt-dot"></div>
      <div>
        <div class="apt-name">${apt.owner || apt.name}</div>
        <div class="apt-sub">${apt.notes || apt.name}</div>
      </div>
    </div>
  `).join('');
}

function selectApt(id) {
  selectedApt = apartments.find(a => a.id === id);
  extraCosts = [];
  currentParsed = [];
  renderSidebar();
  renderMain();
}

// â”€â”€â”€ MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let pendingAptId = null;

// â”€â”€â”€ EXCEL VALIDÃCIÃ“ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function validateExcel(data) {
  // data = array of rows from sheet_to_json
  if (!data || data.length < 3) return { valid: false, reason: 'A fÃ¡jl tÃºl kevÃ©s sort tartalmaz.' };

  const allText = data.map(r => (r||[]).map(c => String(c||'').toLowerCase()).join('|')).join('\n');

  // Check for known patterns
  const hasCheckIn = allText.includes('check in');
  const hasCheckOut = allText.includes('check out');
  const hasGuest = allText.includes('bÃ©rlÅ‘') || allText.includes('Ğ±Ñ€Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²ĞºĞ°');
  const hasPlatform = allText.includes('felÃ¼let') || allText.includes('Ğ¿Ğ»Ğ°Ñ‚Ñ„Ğ¾Ñ€Ğ¼Ğ°') || allText.includes('booking') || allText.includes('airbnb');
  const hasRevenue = allText.includes('bevÃ©tel') || allText.includes('Ğ´Ğ¾Ñ…Ğ¾Ğ´') || allText.includes('huf');
  const hasAsboth = data.some(r => String((r||[])[1]||'').toLowerCase().match(/^booking$|^airbnb$/));
  const hasNefelejcs = data.some((r,i) => String((r||[])[1]||'') === '1' && String((r||[])[2]||'').toLowerCase().includes('booking'));

  if ((hasCheckIn && hasCheckOut && hasPlatform) || hasAsboth || hasNefelejcs) {
    return { valid: true };
  }

  if (hasRevenue && hasPlatform) {
    return { valid: true }; // Partial match, allow
  }

  return { 
    valid: false, 
    reason: 'Nem ismerhetÅ‘ fel apartman elszÃ¡molÃ¡si sablon. EllenÅ‘rizd hogy a megfelelÅ‘ fÃ¡jlt tÃ¶ltÃ¶tted-e fel.'
  };
}

// Bulk upload - multiple files at once
function handleBulkUpload(e) {
  const files = Array.from(e.target.files);
  if (!files.length) return;

  const newAptIds = [];
  const validationErrors = [];
  let processed = 0;

  files.forEach((file, idx) => {
    const reader = new FileReader();
    reader.onload = (ev) => {
      // Validate Excel structure before accepting
      try {
        const base64 = ev.target.result.split(',')[1];
        const binary = atob(base64);
        const bytes = new Uint8Array(binary.length);
        for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
        const wb = XLSX.read(bytes, { type: 'array' });
        // Check last non-summary sheet
        let sheetName = wb.SheetNames[wb.SheetNames.length - 1];
        for (let i = wb.SheetNames.length - 1; i >= 0; i--) {
          const n = wb.SheetNames[i].toLowerCase();
          if (!n.includes('Ğ³Ğ¾Ğ´') && !n.includes('Ã¶sszes') && !n.includes('munka') && n !== 'sheet1') {
            sheetName = wb.SheetNames[i]; break;
          }
        }
        const sheetData = XLSX.utils.sheet_to_json(wb.Sheets[sheetName], { header: 1, defval: null, blankrows: true });
        const validation = validateExcel(sheetData);
        if (!validation.valid) {
          // Warn but still allow â€” don't block upload
          validationErrors.push(`âš  ${file.name}: ${validation.reason}`);
        }
      } catch(err) {
        validationErrors.push(`âš  ${file.name}: Nem sikerÃ¼lt ellenÅ‘rizni a fÃ¡jlt (${err.message})`);
      }

      const id = `${Date.now()}_${idx}_${Math.random().toString(36).substr(2,5)}`;
      const name = file.name.replace(/\.[^.]+$/, '');
      const exists = apartments.find(a => a.name === name);
      if (exists) {
        excelFiles[exists.id] = { data: ev.target.result, name: file.name };
      } else {
        const apt = { id, name, owner: '', notes: '' };
        apartments.push(apt);
        excelFiles[id] = { data: ev.target.result, name: file.name };
        newAptIds.push(id);
      }

      processed++;
      if (processed === files.length) finalizeBulkUpload(e, newAptIds, validationErrors);
    };
    reader.readAsDataURL(file);
  });
}

function finalizeBulkUpload(e, newAptIds, errors) {
  saveState('apartments', apartments);
  saveState('excelFiles', excelFiles);
  if (newAptIds.length > 0) {
    selectedApt = apartments.find(a => a.id === newAptIds[0]);
    pendingAptId = newAptIds[0];
  }
  renderSidebar();
  renderMain();
  if (errors.length > 0) {
    // Show validation errors
    const errMsg = errors.join('\n');
    showStatus(errMsg, 'error');
    // Also show modal if some valid files were uploaded
    if (newAptIds.length > 0) {
      setTimeout(() => showEditModal(newAptIds[0], newAptIds.length), 500);
    }
  } else if (newAptIds.length > 0) {
    showEditModal(newAptIds[0], newAptIds.length);
  }
  e.target.value = '';
}

function showEditModal(aptId, count) {
  const apt = apartments.find(a => a.id === aptId);
  if (!apt) return;
  pendingAptId = aptId;
  document.getElementById('addModal').classList.add('show');
  document.getElementById('newAptOwner').value = apt.owner || '';
  document.getElementById('newAptNotes').value = apt.notes || '';
  const badge = document.getElementById('modalFileBadge');
  badge.innerHTML = count > 1
    ? `<div class="file-badge">âœ“ ${count} Excel fÃ¡jl feltÃ¶ltve</div>`
    : `<div class="file-badge">âœ“ ${apt.name}</div>`;
  setTimeout(() => document.getElementById('newAptOwner').focus(), 100);
}

function showAddModal() {
  // Trigger file upload directly
  document.getElementById('bulkUpload').click();
}

function hideAddModal() {
  document.getElementById('addModal').classList.remove('show');
  pendingAptId = null;
}

function addApartment() {
  const owner = document.getElementById('newAptOwner').value.trim();
  const notes = document.getElementById('newAptNotes').value.trim();

  if (pendingAptId) {
    // Update existing apt
    const apt = apartments.find(a => a.id === pendingAptId);
    if (apt) { apt.owner = owner; apt.notes = notes; }
  } else {
    if (!owner) return;
    const apt = { id: Date.now().toString(), name: owner, owner, notes };
    apartments.push(apt);
  }

  saveState('apartments', apartments);
  hideAddModal();
  renderSidebar();
  if (pendingAptId) selectApt(pendingAptId);
  else selectApt(apartments[apartments.length - 1].id);
}

// (duplicate removed)

// â”€â”€â”€ MAIN CONTENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderMain() {
  if (!selectedApt) return;
  const hasFile = !!excelFiles[selectedApt.id];

  document.getElementById('mainContent').innerHTML = `
    <div class="page-title">${selectedApt.owner || selectedApt.name}</div>
    <div class="page-sub">${selectedApt.notes ? selectedApt.notes + ' Â· ' : ''}Havi elszÃ¡molÃ¡s generÃ¡lÃ³</div>

    <div class="steps">

      <!-- STEP 1: Excel sablon -->
      <div class="step ${hasFile ? 'done' : ''} open" id="step1">
        <div class="step-header" onclick="toggleStep('step1')">
          <div class="step-num">${hasFile ? 'âœ“' : '1'}</div>
          <div>
            <div class="step-title">Excel sablon feltÃ¶ltÃ©se</div>
            <div class="step-desc">${hasFile ? 'Sablon betÃ¶ltve â€” Ãºjra feltÃ¶ltheted ha frissÃ­tetted' : 'TÃ¶ltsd fel az Excel fÃ¡jlt amely tartalmazza az elÅ‘zÅ‘ hÃ³napokat'}</div>
          </div>
        </div>
        <div class="step-body">
          <div class="upload-zone" id="excelZone">
            <input type="file" accept=".xlsx,.xls" onchange="handleExcelUpload(event)" />
            <div class="upload-icon">ğŸ“Š</div>
            <div class="upload-text">HÃºzd ide vagy <strong>kattints a feltÃ¶ltÃ©shez</strong></div>
            <div style="font-size:11px;color:var(--text2);margin-top:4px">.xlsx fÃ¡jl</div>
          </div>
          ${hasFile ? `<div class="file-badge">âœ“ ${selectedApt.name}_sablon.xlsx betÃ¶ltve</div>` : ''}
        </div>
      </div>

      <!-- STEP 2: HÃ³nap -->
      <div class="step open" id="step2">
        <div class="step-header" onclick="toggleStep('step2')">
          <div class="step-num">2</div>
          <div>
            <div class="step-title">HÃ³nap kivÃ¡lasztÃ¡sa</div>
            <div class="step-desc">Melyik hÃ³napra generÃ¡lod az elszÃ¡molÃ¡st?</div>
          </div>
        </div>
        <div class="step-body">
          <label class="field-label">Ã‰v</label>
          <input class="input-field" id="yearInput" value="${new Date().getFullYear()}" style="width:100px" type="number" />
          <label class="field-label">HÃ³nap</label>
          <div class="month-row" id="monthRow">
            ${MONTHS_HU.map((m,i) => `
              <button class="month-btn ${i === new Date().getMonth() ? 'active' : ''}" 
                      onclick="selectMonth(${i}, this)">${m}</button>
            `).join('')}
          </div>
        </div>
      </div>

      <!-- STEP 3: Booking.com payout -->
      <div class="step open" id="step3">
        <div class="step-header" onclick="toggleStep('step3')">
          <div class="step-num">3</div>
          <div>
            <div class="step-title">Booking.com payout adatok</div>
            <div class="step-desc">MÃ¡sold be a Booking.com payout oldal szÃ¶vegÃ©t</div>
          </div>
        </div>
        <div class="step-body">
          <label class="field-label">Booking.com payout szÃ¶veg</label>
          <textarea class="payout-textarea" id="payoutText" 
            placeholder="Feb 5 2026&#10;Jan 29 - Feb 4&#10;0Bltd9f3TZvA4Rya&#10;PDF/CSV&#10;SentHUF 142,715&#10;Booking reference number...&#10;&#10;MÃ¡sold be a teljes Booking.com payout szÃ¶veget ide..."></textarea>
          <div class="warning-note">ğŸ’¡ Booking.com admin â†’ PÃ©nzÃ¼gyek â†’ KifizetÃ©sek oldalrÃ³l mÃ¡sold ki</div>
          
          <div class="divider"></div>
          
          <label class="field-label">Airbnb payout szÃ¶veg</label>
          <textarea class="payout-textarea" id="airbnbText" 
            placeholder="MÃ¡sold be az Airbnb payout / tranzakciÃ³ szÃ¶veget ide...&#10;&#10;pl.:&#10;VendÃ©g neve&#10;BejelentkezÃ©s: 2026. jan. 5.&#10;KijelentkezÃ©s: 2026. jan. 9.&#10;KifizetÃ©s: 85,94 USD / EUR&#10;..."></textarea>
          <div class="warning-note">ğŸ’¡ Airbnb â†’ FizetÃ©sek â†’ TranzakciÃ³k oldalrÃ³l mÃ¡sold ki â€” vagy tÃ¶ltsd fel a CSV exportot</div>
          
          <button class="parse-btn" onclick="parsePayout()">â–¶ MindkettÅ‘ feldolgozÃ¡sa</button>
          <div id="parsedPreview"></div>
        </div>
      </div>

      <!-- STEP 4: EgyÃ©b kiadÃ¡sok -->
      <div class="step open" id="step4">
        <div class="step-header" onclick="toggleStep('step4')">
          <div class="step-num">4</div>
          <div>
            <div class="step-title">EgyÃ©b kiadÃ¡sok (opcionÃ¡lis)</div>
            <div class="step-desc">RendkÃ­vÃ¼li kiadÃ¡sok hozzÃ¡adÃ¡sa</div>
          </div>
        </div>
        <div class="step-body">
          <div id="extraList"></div>
          <button class="add-extra-btn" onclick="addExtraRow()">+ KiadÃ¡s hozzÃ¡adÃ¡sa</button>
        </div>
      </div>

      <!-- STEP 5: GenerÃ¡lÃ¡s -->
      <div class="step open" id="step5">
        <div class="step-header" onclick="toggleStep('step5')">
          <div class="step-num">5</div>
          <div>
            <div class="step-title">Excel generÃ¡lÃ¡sa</div>
            <div class="step-desc">Ãšj havi fÃ¼l lÃ©trehozÃ¡sa Ã©s letÃ¶ltÃ©s</div>
          </div>
        </div>
        <div class="step-body">
          <button class="generate-btn" onclick="generateExcel()" id="genBtn">
            â¬‡ ElszÃ¡molÃ¡s generÃ¡lÃ¡sa Ã©s letÃ¶ltÃ©s
          </button>
          <div class="status-bar" id="statusBar"></div>
        </div>
      </div>

    </div>
  `;

  renderExtraList();
}

function toggleStep(id) {
  const step = document.getElementById(id);
  step.classList.toggle('open');
}

function selectMonth(idx, btn) {
  document.querySelectorAll('.month-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
}

function getSelectedMonth() {
  const btns = document.querySelectorAll('.month-btn');
  for (let i = 0; i < btns.length; i++) {
    if (btns[i].classList.contains('active')) return i;
  }
  return new Date().getMonth();
}

// â”€â”€â”€ EXCEL UPLOAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleExcelUpload(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (ev) => {
    excelFiles[selectedApt.id] = {
      data: ev.target.result,
      name: file.name
    };
    saveState('excelFiles', excelFiles);
    renderSidebar();
    renderMain();
  };
  reader.readAsDataURL(file);
}

// â”€â”€â”€ PAYOUT PARSER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parseBooking(text) {
  const results = [];
  const rateMatches = [...text.matchAll(/Currency conversion rate\s*([\d.]+)/g)];
  const netHufMatches = [...text.matchAll(/Net payout\s*HUF\s*([\d,]+)/g)];
  const guestMatches = [...text.matchAll(/(\d{7,12})\s*Reservation\s*([^\n\t]+?)\s*(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s+(\d+)\s+(\d{4})\s*(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s+(\d+)\s+(\d{4})[^â‚¬]*â‚¬\s*([\d,.-]+)[^â‚¬]*â‚¬\s*([\d,.-]+)[^â‚¬]*â‚¬\s*([\d,.-]+)[^â‚¬]*â‚¬\s*([\d,.-]+)/g)];

  for (let i = 0; i < guestMatches.length; i++) {
    const m = guestMatches[i];
    const netEur = parseFloat(m[12].replace(',',''));
    const rate = rateMatches[i] ? parseFloat(rateMatches[i][1]) : null;
    const huf = netHufMatches[i] ? parseInt(netHufMatches[i][1].replace(/,/g,'')) : null;
    results.push({
      platform: 'Booking',
      guest: m[2].trim(),
      checkIn: `${m[5]}. ${m[3].toLowerCase()}. ${m[4]}.`,
      checkOut: `${m[8]}. ${m[6].toLowerCase()}. ${m[7]}.`,
      eur: netEur,
      rate: rate,
      huf: huf
    });
  }
  return results;
}

function parseAirbnb(text) {
  const results = [];
  if (!text.trim()) return results;

  const parseDate = (monthStr, dayStr, yr) => {
    const mo = {jan:'jan',feb:'feb',mar:'mÃ¡r',apr:'Ã¡pr',may:'mÃ¡j',jun:'jÃºn',
                 jul:'jÃºl',aug:'aug',sep:'szep',oct:'okt',nov:'nov',dec:'dec'};
    const key = monthStr.toLowerCase().substring(0,3);
    return `${yr}. ${mo[key] || key}. ${dayStr}.`;
  };

  const lines = text.split('\n').map(l => l.trim()).filter(Boolean);

  // Find block starts: line matching "â‚¬X.XX" or "Ft X,XXX" 
  // followed by a line starting with "Sent" or a month name
  const blockStarts = [];
  for (let i = 0; i < lines.length; i++) {
    const isAmount = /^(Ft\s+[\d,]+(\.\d+)?|â‚¬[\d,.]+|â‚¬\s+[\d,.]+)$/.test(lines[i]);
    const nextLine = lines[i+1] || '';
    const nextOk = /^(Sent|Arriving|January|February|March|April|May|June|July|August|September|October|November|December)/i.test(nextLine);
    if (isAmount && nextOk) blockStarts.push(i);
  }

  // Fallback: find by "Homeãƒ»" lines
  if (blockStarts.length === 0) {
    for (let i = 1; i < lines.length; i++) {
      if (/[ãƒ»â€¢]/.test(lines[i])) {
        // Guest name is the closest non-junk line before this
        for (let j = i-1; j >= Math.max(0, i-5); j--) {
          if (lines[j] && !/^(Ft|â‚¬|Sent|Arriving|\d)/.test(lines[j]) &&
              !/^(January|February|March|April|May|June|July|August|September|October|November|December)/i.test(lines[j])) {
            blockStarts.push(j);
            break;
          }
        }
      }
    }
  }

  for (let b = 0; b < blockStarts.length; b++) {
    const start = blockStarts[b];
    const end = b + 1 < blockStarts.length ? blockStarts[b+1] : lines.length;
    const block = lines.slice(start, end);

    // Payout amount (first line)
    let huf = null, rate = null;
    const hufMatch = block[0].match(/^Ft\s+([\d,]+)/);
    const eurPayMatch = block[0].match(/^â‚¬\s*([\d,.]+)/);
    if (hufMatch) huf = parseInt(hufMatch[1].replace(/,/g,''));

    // Guest name: line just before "Homeãƒ»" or "Homeâ€¢"
    let guest = '', checkIn = '', checkOut = '', year = String(new Date().getFullYear());
    for (let i = 0; i < block.length; i++) {
      if (/[ãƒ»â€¢]/.test(block[i])) {
        // Scan backwards for guest name
        for (let j = i-1; j >= 0; j--) {
          const v = block[j];
          if (!v) continue;
          if (/^(Ft|â‚¬|Sent|Arriving|Pending)/i.test(v)) continue;
          if (/^(January|February|March|April|May|June|July|August|September|October|November|December)/i.test(v)) continue;
          if (v.length < 3) continue;
          guest = v;
          break;
        }

        // Parse date from line like "Homeãƒ»Feb 6 â€“ 8, 2026" or "Homeãƒ»Feb 14 â€“ Mar 2, 2026"
        const dm = block[i].match(/(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)[a-z]*\.?\s+(\d+)\s*[â€“\-]\s*(?:(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)[a-z]*\.?\s+)?(\d+),?\s*(\d{4})/i);
        if (dm) {
          year = dm[5];
          checkIn = parseDate(dm[1], dm[2], year);
          checkOut = parseDate(dm[3] || dm[1], dm[4], year);
        }
        break;
      }
    }

    // Total (EUR)
    let totalEur = null;
    const totalIdx = block.findIndex(l => /Total\s*\(EUR\)/i.test(l));
    if (totalIdx >= 0) {
      for (let j = totalIdx+1; j < Math.min(totalIdx+3, block.length); j++) {
        const m = block[j].match(/^â‚¬\s*([\d,.]+)/);
        if (m) { totalEur = parseFloat(m[1].replace(',','')); break; }
      }
    }

    if (huf && totalEur) rate = Math.round((huf / totalEur) * 100) / 100;

    if (guest && totalEur) {
      results.push({
        guest, checkIn, checkOut,
        eur: totalEur, rate, huf,
        platform: 'Airbnb',
        currency: huf ? 'HUF' : 'EUR'
      });
    }
  }
  return results;
}

function parsePayout() {
  const bookingText = document.getElementById('payoutText').value;
  const airbnbText = document.getElementById('airbnbText').value;
  
  if (!bookingText.trim() && !airbnbText.trim()) { 
    showStatus('KÃ©rlek illeszd be legalÃ¡bb az egyik payout szÃ¶veget!', 'error'); 
    return; 
  }

  const bookingResults = bookingText.trim() ? parseBooking(bookingText) : [];
  const airbnbResults = airbnbText.trim() ? parseAirbnb(airbnbText) : [];
  const results = [...bookingResults, ...airbnbResults];

  if (results.length === 0) {
    showStatus('Nem sikerÃ¼lt foglalÃ¡sokat talÃ¡lni. EllenÅ‘rizd a beillesztett szÃ¶veget.', 'error');
    return;
  }

  currentParsed = results;
  renderParsedPreview();
}

function renderParsedPreview() {
  const el = document.getElementById('parsedPreview');
  if (currentParsed.length === 0) {
    el.innerHTML = '';
    return;
  }

  const bookingCount = currentParsed.filter(r => r.platform === 'Booking').length;
  const airbnbCount = currentParsed.filter(r => r.platform === 'Airbnb').length;

  el.innerHTML = `
    <div style="margin-top:16px;font-size:11px;color:var(--success);font-family:'DM Mono',monospace;margin-bottom:8px">
      âœ“ ${currentParsed.length} foglalÃ¡s azonosÃ­tva
      ${bookingCount ? `<span style="color:var(--accent)"> Â· ${bookingCount} Booking</span>` : ''}
      ${airbnbCount ? `<span style="color:#ff6b35"> Â· ${airbnbCount} Airbnb</span>` : ''}
    </div>
    <table class="parsed-table">
      <thead>
        <tr>
          <th>ForrÃ¡s</th>
          <th>VendÃ©g</th>
          <th>Check-in</th>
          <th>Check-out</th>
          <th>NettÃ³ EUR</th>
          <th>Ãrfolyam</th>
          <th>HUF (szÃ¡mlÃ¡n)</th>
        </tr>
      </thead>
      <tbody>
        ${currentParsed.map((r, i) => `
          <tr>
            <td style="color:${r.platform === 'Airbnb' ? '#ff6b35' : 'var(--accent)'}; font-family:'DM Mono',monospace; font-size:11px">${r.platform}</td>
            <td>${r.guest}</td>
            <td>${r.checkIn}</td>
            <td>${r.checkOut}</td>
            <td class="eur">â‚¬ ${r.eur}</td>
            <td class="num">${r.rate || (r.platform === 'Airbnb' ? '<span style="color:var(--text2)">â€”</span>' : '<span style="color:var(--danger)">?</span>')}</td>
            <td class="num">${r.huf ? r.huf.toLocaleString('hu') + ' HUF' : (r.platform === 'Airbnb' && r.currency === 'EUR' ? '<span style="color:var(--text2)">EUR kif.</span>' : '<span style="color:var(--danger)">?</span>')}</td>
          </tr>
        `).join('')}
      </tbody>
    </table>
    <div style="margin-top:10px;font-size:11px;color:var(--text2)">
      ğŸ’¡ Airbnb: ha HUF-ban utalt, az Ã¡rfolyam automatikusan szÃ¡mÃ­tÃ³dik. Ha EUR-ban utalt, a HUF oszlopban "EUR kif." jelenik meg.
    </div>
  `;
}

// â”€â”€â”€ EXTRA COSTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addExtraRow() {
  extraCosts.push({ desc: '', amount: '' });
  renderExtraList();
}

function removeExtra(i) {
  extraCosts.splice(i, 1);
  renderExtraList();
}

function renderExtraList() {
  const el = document.getElementById('extraList');
  if (!el) return;
  if (extraCosts.length === 0) {
    el.innerHTML = '<div style="font-size:12px;color:var(--text2);margin-bottom:8px">Nincs egyÃ©b kiadÃ¡s</div>';
    return;
  }
  el.innerHTML = extraCosts.map((c, i) => `
    <div class="extra-row">
      <input class="input-field wide" placeholder="LeÃ­rÃ¡s (pl. tÃ¶rÃ¶lkÃ¶zÅ‘)" 
             value="${c.desc}" onchange="extraCosts[${i}].desc=this.value" />
      <input class="input-field" style="width:120px" placeholder="HUF Ã¶sszeg" type="number"
             value="${c.amount}" onchange="extraCosts[${i}].amount=this.value" />
      <button class="remove-btn" onclick="removeExtra(${i})">Ã—</button>
    </div>
  `).join('');
}

// â”€â”€â”€ SABLON FELISMERÃ‰S â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// Detect all apartment blocks in a sheet
// Returns array of {name, headerRow, dataStart, dataEnd, cols}
function detectBlocks(templateData) {
  const blocks = [];
  
  for (let r = 0; r < templateData.length; r++) {
    const row = templateData[r] || [];
    const rowStr = row.map(c => String(c || '').toLowerCase()).join('|');
    
    // Standard header row: has "check in" AND "check out"  
    if (rowStr.includes('check in') && rowStr.includes('check out')) {
      const cols = { platform:-1, guest:-1, checkIn:-1, checkOut:-1, invoice:-1, eur:-1, huf:-1 };
      for (let c = 0; c < row.length; c++) {
        const v = String(row[c] || '').toLowerCase().trim();
        if (v.includes('felÃ¼let') || v.includes('Ğ¿Ğ»Ğ°Ñ‚Ñ„Ğ¾Ñ€Ğ¼Ğ°')) cols.platform = c;
        if (v.includes('bÃ©rlÅ‘') || v.includes('Ğ±Ñ€Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²ĞºĞ°')) cols.guest = c;
        if (v === 'check in') cols.checkIn = c;
        if (v === 'check out') cols.checkOut = c;
        if (v.includes('szÃ¡mla') || v.includes('Ğ¿Ñ€Ğ¸ÑˆĞ»Ğ¾')) cols.invoice = c;
        if (v.includes('eu bevÃ©tel') || v.includes('eu Ğ´Ğ¾Ñ…Ğ¾Ğ´') || v === 'eu bevÃ©tel') cols.eur = c;
        if ((v.includes('huf') && (v.includes('bevÃ©t') || v.includes('Ğ´Ğ¾Ñ…Ğ¾Ğ´'))) || v === 'huf bevÃ©t') cols.huf = c;
        // Margit/Serena offset: platform col[1], guest col[2] etc
        if (v.includes('eu bevÃ©tel') || v === 'eu bevÃ©tel') cols.eur = c;
        if (v.includes('huf forint') || v.includes('huf bevÃ©t')) cols.huf = c;
        if (v.includes('szÃ¡mlÃ¡ra')) cols.invoice = c;
      }

      // If platform not found at col 0, it might be offset (Margit style: col 0 empty)
      if (cols.platform < 0 && cols.guest >= 0) {
        cols.platform = cols.guest - 1; // platform is one col left of guest
      }
      
      // Find actual data start: skip blank rows after header
      let dataStart = r + 1;
      while (dataStart < templateData.length) {
        const testRow = templateData[dataStart] || [];
        const allEmpty = testRow.every(c => !c || String(c).trim() === '');
        if (!allEmpty) break;
        dataStart++;
      }

      // Find end of data block (SUMMA / Ğ’ÑĞµĞ³Ğ¾ row)
      let dataEnd = templateData.length;
      for (let rr = dataStart; rr < templateData.length; rr++) {
        const rowData = templateData[rr] || [];
        const anyCell = rowData.map(c => String(c||'').toLowerCase()).join('|');
        if (anyCell.includes('summa') || anyCell.includes('Ğ²ÑĞµĞ³Ğ¾')) {
          dataEnd = rr;
          break;
        }
      }
      
      // Get block name from rows above header
      let blockName = '';
      for (let rr = r - 1; rr >= Math.max(0, r - 5); rr--) {
        const nameRow = templateData[rr] || [];
        for (const cell of nameRow) {
          const v = String(cell || '').trim();
          if (v && v.length > 2 && !v.match(/^\d/) && 
              !v.toLowerCase().match(/takarÃ­tÃ¡s|management|ifa|egyÃ©b|ÑƒĞ±Ğ¾Ñ€ĞºĞ°|bevÃ©telek|kiadÃ¡sok|Ğ´Ğ¾Ñ…Ğ¾Ğ´Ñ‹|Ñ€Ğ°ÑÑ…Ğ¾Ğ´Ñ‹/)) {
            blockName = v;
            break;
          }
        }
        if (blockName) break;
      }
      
      blocks.push({ type: 'STANDARD', name: blockName, headerRow: r, dataStart, dataEnd, cols });
    }
  }
  
  // ASBOTH style: no check in/out columns, data starts from row with booking/airbnb
  // EUR col0, platform col1, guest+date col2, invoice col3
  if (blocks.length === 0) {
    const firstBookingRow = templateData.findIndex(row => 
      String((row || [])[1] || '').toLowerCase().match(/^booking$|^airbnb$/)
    );
    if (firstBookingRow >= 0) {
      // Find each sub-block by looking for "bevÃ©tel forintban" or similar summary lines
      let dataStart = firstBookingRow;
      while (dataStart < templateData.length) {
        let dataEnd = templateData.length;
        let blockName = '';
        // Get block name from rows above
        for (let rr = dataStart - 1; rr >= Math.max(0, dataStart - 3); rr--) {
          const nameRow = templateData[rr] || [];
          for (const cell of nameRow) {
            const v = String(cell || '').trim();
            if (v && v.length > 2 && !v.match(/^\d/) && 
                !v.toLowerCase().match(/takarÃ­tÃ¡s|management|ifa|tÃ©nylegesen|bevÃ©tel|nettÃ³|Ã¡rfolyam/)) {
              blockName = v; break;
            }
          }
          if (blockName) break;
        }
        // Find end
        for (let rr = dataStart + 1; rr < templateData.length; rr++) {
          const v = String((templateData[rr] || [])[0] || '').toLowerCase();
          if (v.includes('bevÃ©tel') || v.includes('Ã¶sszesen') || v.includes('management') || v.includes('nettÃ³')) {
            dataEnd = rr; break;
          }
        }
        blocks.push({
          type: 'ASBOTH', name: blockName, headerRow: -1, dataStart, dataEnd,
          cols: { platform: 1, guest: 2, invoice: 3, eur: 0, huf: 3 }
        });
        // Find next block
        let nextStart = -1;
        for (let rr = dataEnd + 1; rr < templateData.length; rr++) {
          if (String((templateData[rr] || [])[1] || '').toLowerCase().match(/^booking$|^airbnb$/)) {
            nextStart = rr; break;
          }
        }
        if (nextStart < 0) break;
        dataStart = nextStart;
      }
    }
  }

  // NEFELEJCS style: row number | platform | guest+date | HUF | EUR
  if (blocks.length === 0) {
    for (let r = 0; r < templateData.length; r++) {
      const row = templateData[r] || [];
      if (String(row[1] || '') === '1' && String(row[2] || '').toLowerCase().match(/booking|airbnb/)) {
        let dataEnd = templateData.length;
        for (let rr = r; rr < templateData.length; rr++) {
          const v = String((templateData[rr] || [])[1] || '').toLowerCase();
          if (v.includes('Ğ²ÑĞµĞ³Ğ¾') || v.includes('Ã¶sszesen')) { dataEnd = rr; break; }
        }
        let blockName = '';
        for (let rr = r - 1; rr >= Math.max(0, r - 3); rr--) {
          for (const cell of (templateData[rr] || [])) {
            const v = String(cell || '').trim();
            if (v && v.length > 2 && !v.toLowerCase().match(/Ğ´Ğ¾Ñ…Ğ¾Ğ´|ÑƒĞ±Ğ¾Ñ€ĞºĞ°|huf|eur/)) { blockName = v; break; }
          }
          if (blockName) break;
        }
        blocks.push({
          type: 'NEFELEJCS', name: blockName, headerRow: r - 1, dataStart: r, dataEnd,
          cols: { rowNum: 1, platform: 2, guest: 3, invoice: 4, eur: 5 }
        });
        // Find next block
        let nextStart = -1;
        for (let rr = dataEnd + 1; rr < templateData.length; rr++) {
          if (String((templateData[rr] || [])[1] || '') === '1') { nextStart = rr; break; }
        }
        if (nextStart < 0) break;
        r = nextStart - 1;
      }
    }
  }

  return blocks;
}

// â”€â”€â”€ EXCEL GENERATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function generateExcel() {
  if (!excelFiles[selectedApt.id]) {
    showStatus('ElÅ‘bb tÃ¶ltsd fel az Excel sablont (1. lÃ©pÃ©s)!', 'error'); return;
  }
  if (currentParsed.length === 0) {
    showStatus('ElÅ‘bb dolgozd fel a payout adatokat (3. lÃ©pÃ©s)!', 'error'); return;
  }

  const btn = document.getElementById('genBtn');
  btn.disabled = true;
  btn.textContent = 'â³ GenerÃ¡lÃ¡s folyamatban...';
  showStatus('Excel feldolgozÃ¡sa...', 'info');

  try {
    const month = getSelectedMonth();
    const year = parseInt(document.getElementById('yearInput').value);
    const monthName = MONTHS_HU[month];
    const fileData = excelFiles[selectedApt.id];

    const base64 = fileData.data.split(',')[1];
    const binary = atob(base64);
    const bytes = new Uint8Array(binary.length);
    for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);

    const workbook = XLSX.read(bytes, { type: 'array', cellStyles: true });
    const sheets = workbook.SheetNames;

    // Find best template sheet (most recent non-summary)
    let templateSheetName = sheets[sheets.length - 1];
    for (let i = sheets.length - 1; i >= 0; i--) {
      const n = sheets[i].toLowerCase();
      if (!n.includes('Ğ³Ğ¾Ğ´') && !n.includes('Ã¶sszes') && !n.includes('munka') && n !== 'sheet1') {
        templateSheetName = sheets[i]; break;
      }
    }
    const templateSheet = workbook.Sheets[templateSheetName];
    // blankrows:true â€” Ã¼res sorok megmaradnak, indexek pontosan egyeznek az Excel sorokkal
    const templateData = XLSX.utils.sheet_to_json(templateSheet, { header: 1, defval: null, blankrows: true });

    // Detect blocks
    const blocks = detectBlocks(templateData);
    console.log('Blocks:', blocks.map(b => `${b.type}:${b.name} R${b.dataStart+1}-${b.dataEnd+1}`));

    // Deep copy â€” megÅ‘rzi az Ã¶sszes formÃ¡zÃ¡st, kÃ©pletet, stÃ­lust
    const newSheet = JSON.parse(JSON.stringify(templateSheet));

    // Filter bookings for selected month
    const monthFilter = currentParsed.filter(b => {
      const ci = (b.checkIn || '').toLowerCase();
      return ci.includes(MONTHS_EN[month].toLowerCase()) ||
             ci.includes(monthName.toLowerCase().substring(0, 3)) ||
             ci.includes(String(year));
    });
    const bookingsToUse = monthFilter.length > 0 ? monthFilter : currentParsed;

    // Process each block
    for (const block of blocks) {
      // Multi-block sheets: csak az elsÅ‘ blokkba Ã­runk automatikusan
      const blockBookings = (blocks.length > 1 && blocks.indexOf(block) > 0) ? [] : bookingsToUse;

      if (block.type === 'STANDARD') {
        const cols = block.cols;

        // KÃ©plet oszlopok Ã©s Ã¡rfolyam oszlop detektÃ¡lÃ¡sa a TEMPLATE sheet alapjÃ¡n
        // (nem a newSheet-bÅ‘l, mert ott ugyanÃºgy tÃ¡rolÃ³dnak)
        const formulaCols = new Set();
        let rateCol = -1;

        for (let ri = block.dataStart; ri < Math.min(block.dataStart + 5, block.dataEnd); ri++) {
          for (let c = 0; c < 30; c++) {
            const cell = templateSheet[XLSX.utils.encode_cell({ r: ri, c })];
            if (cell && cell.f) formulaCols.add(c);
          }
        }

        // Ãrfolyam oszlop: fejlÃ©c alapjÃ¡n
        for (let c = 0; c < 30; c++) {
          const cell = templateSheet[XLSX.utils.encode_cell({ r: block.headerRow, c })];
          if (cell && cell.v) {
            const v = String(cell.v).toLowerCase();
            if (v.includes('euro') || v.includes('Ã¡rfolyam') || v.includes('ĞºÑƒÑ€Ñ') || v.includes('kÃ¶zÃ©p')) {
              rateCol = c;
            }
          }
        }

        // Input oszlopok = a header sorban nÃ©vvel rendelkezÅ‘, NEM kÃ©plet oszlopok
        const inputCols = new Set();
        for (let c = 0; c < 30; c++) {
          if (formulaCols.has(c)) continue;
          const headerCell = templateSheet[XLSX.utils.encode_cell({ r: block.headerRow, c })];
          if (headerCell && headerCell.v) inputCols.add(c);
        }
        // Mindig hozzÃ¡adjuk az alap input oszlopokat
        [cols.platform, cols.guest, cols.checkIn, cols.checkOut, cols.invoice, cols.eur, rateCol]
          .filter(c => c >= 0 && !formulaCols.has(c))
          .forEach(c => inputCols.add(c));

        console.log(`  inputCols=[${[...inputCols]}] formulaCols=[${[...formulaCols]}] rateCol=${rateCol}`);

        // Input cellÃ¡k tÃ¶rlÃ©se (kÃ©pleteket NEM bÃ¡ntjuk)
        for (let ri = block.dataStart; ri < block.dataEnd; ri++) {
          inputCols.forEach(c => {
            const addr = XLSX.utils.encode_cell({ r: ri, c });
            if (newSheet[addr] && !newSheet[addr].f) {
              newSheet[addr].v = '';
              newSheet[addr].t = 's';
            }
          });
        }

        // FoglalÃ¡sok beÃ­rÃ¡sa
        for (let i = 0; i < blockBookings.length; i++) {
          const r = block.dataStart + i;
          if (r >= block.dataEnd) break;
          const b = blockBookings[i];

          const setVal = (c, val) => {
            if (c < 0 || formulaCols.has(c)) return;
            const addr = XLSX.utils.encode_cell({ r, c });
            if (!newSheet[addr]) newSheet[addr] = {};
            newSheet[addr].v = val;
            newSheet[addr].t = typeof val === 'number' ? 'n' : 's';
            delete newSheet[addr].f;
          };

          setVal(cols.platform, b.platform === 'Airbnb' ? 'Airbnb' : 'booking');
          setVal(cols.guest, b.guest);
          if (cols.checkIn >= 0) setVal(cols.checkIn, b.checkIn);
          if (cols.checkOut >= 0) setVal(cols.checkOut, b.checkOut);
          if (cols.invoice >= 0 && b.huf) setVal(cols.invoice, b.huf);
          if (cols.eur >= 0) setVal(cols.eur, b.eur);
          if (rateCol >= 0 && b.rate) setVal(rateCol, b.rate);
        }

      } else if (block.type === 'ASBOTH') {
        // AsbÃ³th: col0=EUR, col1=platform, col2=guest+dÃ¡tum egy cellÃ¡ban, col3=HUF
        for (let ri = block.dataStart; ri < block.dataEnd; ri++) {
          [0,1,2,3].forEach(c => {
            const addr = XLSX.utils.encode_cell({ r: ri, c });
            if (newSheet[addr] && !newSheet[addr].f) { newSheet[addr].v = ''; newSheet[addr].t = 's'; }
          });
        }
        for (let i = 0; i < blockBookings.length; i++) {
          const r = block.dataStart + i;
          if (r >= block.dataEnd) break;
          const b = blockBookings[i];
          const setV = (c, v) => {
            const addr = XLSX.utils.encode_cell({ r, c });
            if (!newSheet[addr]) newSheet[addr] = {};
            newSheet[addr].v = v; newSheet[addr].t = typeof v === 'number' ? 'n' : 's';
          };
          setV(0, b.eur);
          setV(1, b.platform === 'Airbnb' ? 'airbnb' : 'booking');
          setV(2, `${b.guest}\t${b.checkIn}\t${b.checkOut}`);
          if (b.huf) setV(3, b.huf);
        }

      } else if (block.type === 'NEFELEJCS') {
        const cols = block.cols;
        for (let ri = block.dataStart; ri < block.dataEnd; ri++) {
          [1,2,3,4,5].forEach(c => {
            const addr = XLSX.utils.encode_cell({ r: ri, c });
            if (newSheet[addr] && !newSheet[addr].f) { newSheet[addr].v = ''; newSheet[addr].t = 's'; }
          });
        }
        for (let i = 0; i < blockBookings.length; i++) {
          const r = block.dataStart + i;
          if (r >= block.dataEnd) break;
          const b = blockBookings[i];
          const setV = (c, v) => {
            const addr = XLSX.utils.encode_cell({ r, c });
            if (!newSheet[addr]) newSheet[addr] = {};
            newSheet[addr].v = v; newSheet[addr].t = typeof v === 'number' ? 'n' : 's';
          };
          setV(cols.rowNum, i + 1);
          setV(cols.platform, b.platform === 'Airbnb' ? 'airbnb' : 'booking');
          setV(cols.guest, `${b.guest}\t${b.checkIn}\t${b.checkOut}`);
          if (b.huf) setV(cols.invoice, b.huf);
          setV(cols.eur, b.eur);
        }
      }
    }

    // Extra kiadÃ¡sok
    for (let r = 0; r < templateData.length; r++) {
      for (let c = 0; c < (templateData[r] || []).length; c++) {
        const v = String((templateData[r] || [])[c] || '').toLowerCase();
        if (v.includes('egyÃ©b kiadÃ¡s') || v.includes('egyÃ©b nem terv')) {
          if (extraCosts.length > 0) {
            const total = extraCosts.reduce((s, x) => s + (parseFloat(x.amount) || 0), 0);
            const addr = XLSX.utils.encode_cell({ r, c: c + 1 });
            if (!newSheet[addr]) newSheet[addr] = {};
            newSheet[addr].v = total; newSheet[addr].t = 'n';
          }
        }
      }
    }

    // Ãšj fÃ¼l neve
    let newSheetName;
    const aptShort = (selectedApt.notes || selectedApt.name).split(',')[0].trim().substring(0, 12);
    if (templateSheetName.match(/ĞšĞ²Ğ°Ñ€Ñ‚Ğ¸Ñ€Ñ‹|Ğ”ĞµĞ½Ğ¸Ñ/)) {
      const m = String(month + 1).padStart(2, '0');
      newSheetName = templateSheetName.replace(/\d{2}\.\d{4}/, `${m}.${year}`).substring(0, 31);
    } else if (templateSheetName.match(/\d{4}\.\d{2}/)) {
      newSheetName = `${year}.${String(month + 1).padStart(2, '0')}`;
    } else {
      newSheetName = `${monthName}i elsz ${year} ${aptShort}`.substring(0, 31);
    }
    let finalName = newSheetName;
    let suffix = 2;
    while (workbook.SheetNames.includes(finalName)) {
      finalName = `${newSheetName.substring(0, 27)}_${suffix++}`;
    }

    workbook.SheetNames.push(finalName);
    workbook.Sheets[finalName] = newSheet;

    const wbout = XLSX.write(workbook, { bookType: 'xlsx', type: 'array', cellStyles: true });
    const blob = new Blob([wbout], { type: 'application/octet-stream' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${selectedApt.name}_${year}_${monthName}.xlsx`;
    a.click();
    URL.revokeObjectURL(url);

    showStatus(`âœ“ "${finalName}" fÃ¼l lÃ©trehozva Ã©s letÃ¶ltve!`, 'info');
    btn.textContent = 'âœ“ LetÃ¶ltve!';
    setTimeout(() => { btn.disabled = false; btn.textContent = 'â¬‡ ElszÃ¡molÃ¡s generÃ¡lÃ¡sa Ã©s letÃ¶ltÃ©s'; }, 3000);

  } catch (err) {
    console.error(err);
    showStatus('Hiba: ' + err.message, 'error');
    btn.disabled = false;
    btn.textContent = 'â¬‡ ElszÃ¡molÃ¡s generÃ¡lÃ¡sa Ã©s letÃ¶ltÃ©s';
  }
}

function showStatus(msg, type) {
  const bar = document.getElementById('statusBar');
  if (!bar) return;
  bar.textContent = msg;
  bar.className = `status-bar ${type} show`;
}

// â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
renderSidebar();

// Keyboard shortcut for modal
document.getElementById('newAptOwner').addEventListener('keydown', e => {
  if (e.key === 'Enter') document.getElementById('newAptNotes').focus();
});
</script>
</body>
</html>
